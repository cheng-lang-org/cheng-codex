# Feature list helpers for codex-cheng

import system
import seqs
type
    FeatureSpec =
        key: str
        stage: str
        defaultEnabled: bool

fn listFeatureSpecs(): FeatureSpec[] =
    var specs: FeatureSpec[] = newSeq[FeatureSpec]()
    seqAdd(specs, FeatureSpec(key: "undo", stage: "stable", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "parallel", stage: "stable", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "view_image_tool", stage: "stable", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "shell_tool", stage: "stable", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "warnings", stage: "stable", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "web_search_request", stage: "stable", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "unified_exec", stage: "beta", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "shell_snapshot", stage: "beta", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "apply_patch_freeform", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "exec_policy", stage: "experimental", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "experimental_windows_sandbox", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "elevated_windows_sandbox", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "remote_compaction", stage: "experimental", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "remote_models", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "skills", stage: "experimental", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "powershell_utf8", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "tui2", stage: "experimental", defaultEnabled: true))
    seqAdd(specs, FeatureSpec(key: "collab", stage: "experimental", defaultEnabled: false))
    seqAdd(specs, FeatureSpec(key: "collaboration_modes", stage: "stable", defaultEnabled: true))
    return specs

fn configBoolValue(key: str, defaultValue: bool): bool =
    let raw = readConfigValue(key)
    if len(raw) == 0:
        return defaultValue
    let norm = normalizePolicy(trimLine(raw))
    if norm == "true" || norm == "1" || norm == "yes":
        return true
    if norm == "false" || norm == "0" || norm == "no":
        return false
    return defaultValue

fn featureEnabled(spec: FeatureSpec): bool =
    let key = "features." + spec.key
    return configBoolValue(key, spec.defaultEnabled)

fn isFeatureEnabled(key: str): bool =
    if len(key) == 0:
        return false
    let specs = listFeatureSpecs()
    var idx: int32 = 0
    while idx < len(specs):
        if specs[idx].key == key:
            return featureEnabled(specs[idx])
        idx = idx + 1
    return false

fn runFeaturesList(): int32 =
    let specs = listFeatureSpecs()
    var nameWidth: int32 = 0
    var stageWidth: int32 = 0
    var idx: int32 = 0
    while idx < len(specs):
        let keyLen = len(specs[idx].key)
        if keyLen > nameWidth:
            nameWidth = keyLen
        let stageLen = len(specs[idx].stage)
        if stageLen > stageWidth:
            stageWidth = stageLen
        idx = idx + 1
    idx = 0
    while idx < len(specs):
        let spec = specs[idx]
        let enabled = featureEnabled(spec)
        var enabledText = "false"
        if enabled:
            enabledText = "true"
        var row = spec.key
        var keyPad = nameWidth - len(spec.key)
        while keyPad > 0:
            row = row + " "
            keyPad = keyPad - 1
        row = row + "  " + spec.stage
        var stagePad = stageWidth - len(spec.stage)
        while stagePad > 0:
            row = row + " "
            stagePad = stagePad - 1
        row = row + "  " + enabledText
        printLine(row)
        idx = idx + 1
    return 0

fn isKnownFeatureKey(key: str): bool =
    if len(key) == 0:
        return false
    let specs = listFeatureSpecs()
    var idx: int32 = 0
    while idx < len(specs):
        if specs[idx].key == key:
            return true
        idx = idx + 1
    return false
