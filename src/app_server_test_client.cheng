# Cheng app-server test client

import system
import std/os
import seqs
fn defaultAppServerBin(): str =
    let envBin = os.getEnv("CODEX_BIN")
    if len(envBin) > 0:
        return envBin
    let envCheng = os.getEnv("CODEX_CHENG_BIN")
    if len(envCheng) > 0:
        return envCheng
    return "codex-cheng"

fn appServerTestUsage(): int32 =
    printLine("usage: codex-cheng app-server-test [--codex-bin <path>] <command> [prompt]")
    printLine("commands:")
    printLine("  send-message            send a V2 message")
    printLine("  send-message-v2         alias for send-message")
    printLine("  trigger-cmd-approval    force a command approval flow")
    printLine("  trigger-patch-approval  force a patch approval flow")
    return 0

fn appServerTestRequest(id: int32, methodName: str, paramsJson: str): str =
    var fields: seq[str] = newSeq[str]()
    seqAdd(fields, jstrPair("jsonrpc", jstrString("2.0")))
    seqAdd(fields, jstrPair("id", intToStr(id)))
    seqAdd(fields, jstrPair("method", jstrString(methodName)))
    if len(paramsJson) > 0:
        seqAdd(fields, jstrPair("params", paramsJson))
    return jstrObject(fields)

fn appServerTestNotification(methodName: str, paramsJson: str): str =
    var fields: seq[str] = newSeq[str]()
    seqAdd(fields, jstrPair("jsonrpc", jstrString("2.0")))
    seqAdd(fields, jstrPair("method", jstrString(methodName)))
    if len(paramsJson) > 0:
        seqAdd(fields, jstrPair("params", paramsJson))
    return jstrObject(fields)

fn appServerTestApprovalResponse(id: int32, decision: str, forSession: bool): str =
    var resultFields: seq[str] = newSeq[str]()
    seqAdd(resultFields, jstrPair("decision", jstrString(decision)))
    seqAdd(resultFields, jstrPair("forSession", jstrBool(forSession)))
    var fields: seq[str] = newSeq[str]()
    seqAdd(fields, jstrPair("jsonrpc", jstrString("2.0")))
    seqAdd(fields, jstrPair("id", intToStr(id)))
    seqAdd(fields, jstrPair("result", jstrObject(resultFields)))
    return jstrObject(fields)

fn appServerTestSendLine(fd: int32, line: str): bool =
    return writeAll(fd, line + "\n")

fn appServerTestReadLine(fd: int32, buffer: var str, outLine: var str): bool =
    var local = "" + buffer
    while true:
        let idx = indexOfSubstr(local, "\n", 0)
        if idx >= 0:
            var line = __cheng_slice_string(local, 0, idx - 1, false)
            if idx + 1 < len(local):
                local = __cheng_slice_string(local, idx + 1, len(local) - 1, false)
            else:
                local = ""
            if len(line) > 0 && line[len(line) - 1] == '\r':
                line = __cheng_slice_string(line, 0, len(line) - 2, false)
            outLine = line
            buffer = local
            return true
        let chunk = readChunk(fd, 4096)
        if len(chunk) == 0:
            if len(local) > 0:
                outLine = local
                buffer = ""
                return true
            buffer = local
            return false
        local = local + chunk
    return false

fn appServerTestRunSession(codexBin: str, prompt: str, approvalPolicy: str): int32 =
    var readFd: int32 = -1
    var writeFd: int32 = -1
    var pid: int64 = 0
    let cmd = shellQuote(codexBin) + " app-server"
    if ! pipeSpawn(cmd, os.getCurrentDir(), &readFd, &writeFd, &pid):
        printErr("failed to spawn app-server")
        return 1
    let initParams = jstrObject(seqStr1(
        jstrPair("clientInfo", jstrObject(seqStr3(
            jstrPair("name", jstrString("codex-cheng-test")),
            jstrPair("title", jstrString("Cheng AppServer Test")),
            jstrPair("version", jstrString("0.1.0"))
        )))
    ))
    appServerTestSendLine(writeFd, appServerTestRequest(1, "initialize", initParams))
    appServerTestSendLine(writeFd, appServerTestNotification("initialized", ""))
    var turnFields: seq[str] = newSeq[str]()
    seqAdd(turnFields, jstrPair("text", jstrString(prompt)))
    if len(approvalPolicy) > 0:
        seqAdd(turnFields, jstrPair("approvalPolicy", jstrString(approvalPolicy)))
    let turnParams = jstrObject(turnFields)
    appServerTestSendLine(writeFd, appServerTestRequest(2, "turn/start", turnParams))
    var buffer = ""
    while true:
        var line = ""
        if ! appServerTestReadLine(readFd, buffer, line):
            break
        if len(line) == 0:
            continue
        printLine(line)
        let methodName = jsonExtractString(line, "method")
        let reqId = jsonExtractInt(line, "id", -1)
        if reqId > 0 && (methodName == "item/commandExecution/requestApproval" || methodName == "item/fileChange/requestApproval"):
            let resp = appServerTestApprovalResponse(reqId, "accept", true)
            appServerTestSendLine(writeFd, resp)
        if methodName == "turn/completed":
            break
    shutdownWrite(writeFd)
    closeFd(writeFd)
    closeFd(readFd)
    var exitCode: int32 = -1
    ptyWait(pid, &exitCode)
    return 0

fn runAppServerTest(args: seq[str], start: int32): int32 =
    var codexBin = defaultAppServerBin()
    var sub = ""
    var promptParts: seq[str] = newSeq[str]()
    var i: int32 = start
    while i < len(args):
        let arg = args[i]
        if arg == "--help" || arg == "-h":
            return appServerTestUsage()
        if arg == "--codex-bin" && i + 1 < len(args):
            codexBin = args[i + 1]
            i = i + 1
        elif hasPrefix(arg, "--codex-bin:"):
            codexBin = dropPrefix(arg, "--codex-bin:")
        elif len(sub) == 0:
            sub = arg
        else:
            seqAdd(promptParts, arg)
        i = i + 1
    if len(sub) == 0:
        return appServerTestUsage()
    var prompt: str = ""
    if len(promptParts) > 0:
        prompt = joinArgs(promptParts, 0)
    if sub == "send-message" || sub == "send-message-v2":
        if len(prompt) == 0:
            prompt = "Hello from codex-cheng app-server test"
        return appServerTestRunSession(codexBin, prompt, "")
    if sub == "trigger-cmd-approval":
        if len(prompt) == 0:
            prompt = "Run `echo codex-approval-test` in the shell."
        return appServerTestRunSession(codexBin, prompt, "on-request")
    if sub == "trigger-patch-approval":
        if len(prompt) == 0:
            prompt = "Create a file codex_test.txt containing: hello"
        return appServerTestRunSession(codexBin, prompt, "on-request")
    printErr("unknown app-server-test command")
    return 2
