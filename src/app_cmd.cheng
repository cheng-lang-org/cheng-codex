# macOS desktop app command support.

import system
import std/os
import cheng/codex/common

const CODEX_APP_DEFAULT_DMG_URL = "https://persistent.oaistatic.com/codex-app-prod/Codex.dmg"
const CODEX_APP_BUNDLE_NAME = "Codex.app"
const CODEX_APP_SYSTEM_PATH = "/Applications/Codex.app"

fn appCommandOpts(): uint64 =
    return uint64(os.poUsePath | os.poEvalCommand)

fn appStrEq(a: str, b: str): bool =
    if a == nil || b == nil:
        return false
    if len(a) != len(b):
        return false
    for i in 0..<len(a):
        if ord(a[i]) != ord(b[i]):
            return false
    return true

fn appIsWhitespace(ch: char): bool =
    return ch == ' ' || ch == '\t' || ch == '\r' || ch == '\n'

fn appSlice(text: str, start: int32, stop: int32): str =
    if text == nil:
        return ""
    let n: int32 = len(text)
    if n <= 0:
        return ""
    var s: int32 = start
    var e: int32 = stop
    if s < 0:
        s = 0
    if e >= n:
        e = n - 1
    if e < s:
        return ""
    var out: str = ""
    for i in s..e:
        out = out + $text[i]
    return out

fn appLastIndexOfChar(text: str, needle: char): int32 =
    if text == nil:
        return -1
    var idx: int32 = -1
    for i in 0..<len(text):
        if text[i] == needle:
            idx = i
    return idx

fn appFindMountPointInFields(line: str): str =
    if line == nil:
        return ""
    var fieldStart: int32 = -1
    for i in 0..len(line):
        if i < len(line) && ! appIsWhitespace(line[i]):
            if fieldStart < 0:
                fieldStart = i
            continue
        if fieldStart >= 0:
            let field = appSlice(line, fieldStart, i - 1)
            if hasPrefix(field, "/Volumes/"):
                return field
            fieldStart = -1
    return ""

fn appParseMountPointFromAttachLine(line: str): str =
    if line == nil || indexOfSubstr(line, "/Volumes/", 0) < 0:
        return ""
    let tab = appLastIndexOfChar(line, '\t')
    if tab >= 0 && tab + 1 < len(line):
        let mount = trimLine(appSlice(line, tab + 1, len(line) - 1))
        if hasPrefix(mount, "/Volumes/"):
            return mount
    return appFindMountPointInFields(line)

fn appParseMountPointFromAttachOutput(output: str): str =
    if output == nil:
        return ""
    var start: int32 = 0
    for i in 0..len(output):
        if i == len(output) || output[i] == '\n':
            let line = appSlice(output, start, i - 1)
            let mount = appParseMountPointFromAttachLine(line)
            if len(mount) > 0:
                return mount
            start = i + 1
    return ""

fn appRunShell(command: str): os.ExecCmdResult =
    return os.execCmdEx(command, appCommandOpts(), os.getCurrentDir())

fn appCanonicalizeWorkspacePath(path: str): str =
    var p = path
    if len(p) == 0:
        p = "."
    let cmd = "cd " + shellQuote(p) + " 2>/dev/null && pwd -P"
    let res = appRunShell(cmd)
    if res.exitCode == 0:
        let out = trimLine(res.output)
        if len(out) > 0:
            return out
    return os.absolutePath(p)

fn appHomeApplicationsPath(): str =
    let home = os.getEnvDefault("HOME", "")
    if len(home) == 0:
        return ""
    return os.joinPath(os.joinPath(home, "Applications"), CODEX_APP_BUNDLE_NAME)

fn appFindExistingCodexAppPath(): str =
    if os.dirExists(CODEX_APP_SYSTEM_PATH):
        return CODEX_APP_SYSTEM_PATH
    let userPath = appHomeApplicationsPath()
    if len(userPath) > 0 && os.dirExists(userPath):
        return userPath
    return ""

fn appOpenCodexApp(appPath: str, workspace: str): bool =
    printErr("Opening workspace " + workspace + "...")
    let cmd = "open -a " + shellQuote(appPath) + " " + shellQuote(workspace)
    let res = appRunShell(cmd)
    if res.exitCode == 0:
        return true
    printErr("`open -a " + appPath + " " + workspace + "` exited with " + intToStr(res.exitCode))
    return false

fn appDownloadDmg(downloadUrl: str, destPath: str): bool =
    printErr("Downloading installer...")
    let cmd = "curl -fL --retry 3 --retry-delay 1 -o " + shellQuote(destPath) + " " + shellQuote(downloadUrl)
    let res = appRunShell(cmd)
    if res.exitCode == 0:
        return true
    printErr("curl download failed with " + intToStr(res.exitCode))
    return false

fn appMountDmg(dmgPath: str): str =
    let cmd = "hdiutil attach -nobrowse -readonly " + shellQuote(dmgPath)
    let res = appRunShell(cmd)
    if res.exitCode != 0:
        printErr("`hdiutil attach` failed with " + intToStr(res.exitCode) + ": " + trimLine(res.output))
        return ""
    let mount = appParseMountPointFromAttachOutput(res.output)
    if len(mount) == 0:
        printErr("failed to parse mount point from hdiutil output")
    return mount

fn appDetachDmg(mountPoint: str): bool =
    let cmd = "hdiutil detach " + shellQuote(mountPoint)
    let res = appRunShell(cmd)
    if res.exitCode == 0:
        return true
    return false

fn appFindCodexAppInMount(mountPoint: str): str =
    let direct = os.joinPath(mountPoint, CODEX_APP_BUNDLE_NAME)
    if os.dirExists(direct):
        return direct
    let cmd = "find " + shellQuote(mountPoint) + " -maxdepth 1 -type d -name '*.app' | head -n 1"
    let res = appRunShell(cmd)
    if res.exitCode != 0:
        return ""
    return trimLine(res.output)

fn appCopyAppBundle(srcApp: str, destApp: str): bool =
    let cmd = "ditto " + shellQuote(srcApp) + " " + shellQuote(destApp)
    let res = appRunShell(cmd)
    if res.exitCode == 0:
        return true
    return false

fn appInstallCodexAppBundle(appInVolume: str): str =
    var candidates: str[]
    add(candidates, "/Applications")
    let userApplications = appHomeApplicationsPath()
    if len(userApplications) > 0:
        add(candidates, os.parentDir(userApplications))

    for i in 0..<len(candidates):
        let applicationsDir = argAt(candidates, i)
        printErr("Installing Codex Desktop into " + applicationsDir + "...")
        let mkdirCmd = "mkdir -p " + shellQuote(applicationsDir)
        let mkdirRes = appRunShell(mkdirCmd)
        if mkdirRes.exitCode != 0:
            printErr("warning: failed to create applications dir " + applicationsDir)
            continue
        let destApp = os.joinPath(applicationsDir, CODEX_APP_BUNDLE_NAME)
        if os.dirExists(destApp):
            return destApp
        if appCopyAppBundle(appInVolume, destApp):
            return destApp
        printErr("warning: failed to install Codex.app to " + applicationsDir)
    return ""

fn appMakeTempInstallerDir(): str =
    let cmd = "mktemp -d -t codex-app-installer-XXXXXX"
    let res = appRunShell(cmd)
    if res.exitCode != 0:
        return ""
    return trimLine(res.output)

fn appRemoveTree(path: str) =
    if len(path) == 0:
        return
    let cmd = "rm -rf " + shellQuote(path)
    appRunShell(cmd)

fn appDownloadAndInstallCodex(downloadUrl: str): str =
    let tmpRoot = appMakeTempInstallerDir()
    if len(tmpRoot) == 0:
        printErr("failed to create temp dir")
        return ""
    let dmgPath = os.joinPath(tmpRoot, "Codex.dmg")
    if ! appDownloadDmg(downloadUrl, dmgPath):
        appRemoveTree(tmpRoot)
        return ""

    printErr("Mounting Codex Desktop installer...")
    let mountPoint = appMountDmg(dmgPath)
    if len(mountPoint) == 0:
        appRemoveTree(tmpRoot)
        return ""
    printErr("Installer mounted at " + mountPoint + ".")

    var installed = ""
    let appInVolume = appFindCodexAppInMount(mountPoint)
    if len(appInVolume) == 0:
        printErr("failed to locate Codex.app in mounted dmg")
    else:
        installed = appInstallCodexAppBundle(appInVolume)
        if len(installed) == 0:
            printErr("failed to install Codex.app to any applications directory")

    if ! appDetachDmg(mountPoint):
        printErr("warning: failed to detach dmg at " + mountPoint)
    appRemoveTree(tmpRoot)
    return installed

fn appIsMacHost(): bool =
    let osEnv = normalizePolicy(os.getEnv("OS"))
    if appStrEq(osEnv, "darwin") || appStrEq(osEnv, "macos"):
        return true
    let ostype = normalizePolicy(os.getEnv("OSTYPE"))
    if indexOfSubstr(ostype, "darwin", 0) >= 0:
        return true
    if os.fileExists("/usr/bin/sandbox-exec"):
        return true
    if os.dirExists("/System") && os.dirExists("/Applications"):
        return true
    if os.fileExists("/System/Library/CoreServices/SystemVersion.plist"):
        return true
    let unameRes = os.execCmdEx("uname", uint64(os.poUsePath), os.getCurrentDir())
    if unameRes.exitCode == 0:
        let unameOut = normalizePolicy(trimLine(unameRes.output))
        if appStrEq(unameOut, "darwin"):
            return true
    return false

fn runAppCommand(args: str[], start: int32): int32 =
    var workspace = "."
    var downloadUrl = CODEX_APP_DEFAULT_DMG_URL
    var seenPath = false
    var skipUntil: int32 = start - 1
    for i in start..<len(args):
        if i <= skipUntil:
            continue
        let arg = argAt(args, i)
        if appStrEq(arg, "--help") || appStrEq(arg, "-h"):
            printLine("Launch the Codex desktop app (downloads the macOS installer if missing)")
            printLine("")
            printLine("Usage: codex app [OPTIONS] [PATH]")
            printLine("")
            printLine("Arguments:")
            printLine("  [PATH]")
            printLine("          Workspace path to open in Codex Desktop")
            printLine("          ")
            printLine("          [default: .]")
            printLine("")
            printLine("Options:")
            printConfigFlagHelp()
            printLine("      --download-url <DOWNLOAD_URL>")
            printLine("          Override the macOS DMG download URL (advanced)")
            printLine("          ")
            printLine("          [default: https://persistent.oaistatic.com/codex-app-prod/Codex.dmg]")
            printLine("")
            printEnableFlagHelp()
            printDisableFlagHelp()
            printLine("  -h, --help")
            printLine("          Print help (see a summary with '-h')")
            return 0
        if appStrEq(arg, "--download-url") && i + 1 < len(args):
            downloadUrl = argAt(args, i + 1)
            skipUntil = i + 1
        elif appStrEq(arg, "--download-url"):
            printErr("option '--download-url' requires a value")
            return 2
        elif hasPrefix(arg, "--download-url="):
            downloadUrl = dropPrefix(arg, "--download-url=")
        elif ! seenPath && ! hasPrefix(arg, "-"):
            workspace = arg
            seenPath = true
        else:
            printErr("unknown option: " + arg)
            return 2

    if ! appIsMacHost():
        printErr("`codex app` is only available on macOS")
        return 2

    let absWorkspace = appCanonicalizeWorkspacePath(workspace)
    let existingApp = appFindExistingCodexAppPath()
    if len(existingApp) > 0:
        printErr("Opening Codex Desktop at " + existingApp + "...")
        if appOpenCodexApp(existingApp, absWorkspace):
            return 0
        return 1

    printErr("Codex Desktop not found; downloading installer...")
    let installedApp = appDownloadAndInstallCodex(downloadUrl)
    if len(installedApp) == 0:
        return 1
    printErr("Launching Codex Desktop from " + installedApp + "...")
    if appOpenCodexApp(installedApp, absWorkspace):
        return 0
    return 1
