{
  "suite": "arg0_hooks",
  "cases": [
    {
      "id": "arg0-subcommand-apply-patch-stdin",
      "description": "cheng hidden root apply_patch should match baseline argv0 apply_patch behavior",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "baseline_argv0": "apply_patch",
      "baseline_args": [],
      "cheng_args": ["apply_patch"],
      "cwd": "{{CASE_TMP}}",
      "stdin": "*** Begin Patch\n*** Add File: arg0-subcommand-apply-patch.txt\n+ok\n*** End Patch\n",
      "expect": {
        "exit_code": 0,
        "baseline_paths_exist": ["{{CASE_TMP}}/arg0-subcommand-apply-patch.txt"],
        "cheng_paths_exist": ["{{CASE_TMP}}/arg0-subcommand-apply-patch.txt"]
      }
    },
    {
      "id": "arg0-subcommand-applypatch-stdin",
      "description": "cheng hidden root applypatch should match baseline argv0 applypatch behavior",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "baseline_argv0": "applypatch",
      "baseline_args": [],
      "cheng_args": ["applypatch"],
      "cwd": "{{CASE_TMP}}",
      "stdin": "*** Begin Patch\n*** Add File: arg0-subcommand-applypatch.txt\n+ok\n*** End Patch\n",
      "expect": {
        "exit_code": 0,
        "baseline_paths_exist": ["{{CASE_TMP}}/arg0-subcommand-applypatch.txt"],
        "cheng_paths_exist": ["{{CASE_TMP}}/arg0-subcommand-applypatch.txt"]
      }
    },
    {
      "id": "arg0-subcommand-apply-patch-empty-stdin",
      "description": "cheng hidden root apply_patch usage should match baseline argv0 apply_patch usage",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "baseline_argv0": "apply_patch",
      "baseline_args": [],
      "cheng_args": ["apply_patch"],
      "cwd": "{{CASE_TMP}}",
      "expect": {
        "exit_code": 2,
        "stderr_contains": ["Usage: apply_patch 'PATCH'"]
      }
    },
    {
      "id": "arg0-subcommand-apply-patch-extra-args",
      "description": "cheng hidden root apply_patch argc checks should match baseline argv0 argc checks",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "baseline_argv0": "apply_patch",
      "baseline_args": ["first", "second"],
      "cheng_args": ["apply_patch", "first", "second"],
      "cwd": "{{CASE_TMP}}",
      "expect": {
        "exit_code": 2,
        "stderr_contains": ["Error: apply_patch accepts exactly one argument."]
      }
    },
    {
      "id": "arg0-argv0-apply-patch-stdin",
      "description": "argv0 apply_patch alias should bypass root parser and apply patch",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "argv0": "apply_patch",
      "args": [],
      "cwd": "{{CASE_TMP}}",
      "stdin": "*** Begin Patch\n*** Add File: arg0-argv0-apply-patch.txt\n+ok\n*** End Patch\n",
      "expect": {
        "exit_code": 0,
        "baseline_paths_exist": ["{{CASE_TMP}}/arg0-argv0-apply-patch.txt"],
        "cheng_paths_exist": ["{{CASE_TMP}}/arg0-argv0-apply-patch.txt"]
      }
    },
    {
      "id": "arg0-argv0-applypatch-stdin",
      "description": "argv0 applypatch alias should bypass root parser and apply patch",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "argv0": "applypatch",
      "args": [],
      "cwd": "{{CASE_TMP}}",
      "stdin": "*** Begin Patch\n*** Add File: arg0-argv0-applypatch.txt\n+ok\n*** End Patch\n",
      "expect": {
        "exit_code": 0,
        "baseline_paths_exist": ["{{CASE_TMP}}/arg0-argv0-applypatch.txt"],
        "cheng_paths_exist": ["{{CASE_TMP}}/arg0-argv0-applypatch.txt"]
      }
    },
    {
      "id": "arg0-argv0-apply-patch-empty-stdin",
      "description": "argv0 apply_patch alias without stdin should show usage and exit 2",
      "requires_direct_bin": true,
      "platforms": ["macos", "linux"],
      "argv0": "apply_patch",
      "args": [],
      "cwd": "{{CASE_TMP}}",
      "expect": {
        "exit_code": 2,
        "stderr_contains": ["Usage: apply_patch 'PATCH'"]
      }
    },
    {
      "id": "dotenv-loads-non-codex-and-filters-codex-prefix",
      "description": "dotenv should load HOME but must ignore CODEX_HOME override",
      "files": [
        {
          "path": "{{HOME}}/.codex/.env",
          "content": "HOME={{CASE_TMP}}/dotenv-home\nCODEX_HOME={{CASE_TMP}}/blocked-codex-home\n"
        }
      ],
      "args": ["config", "home"],
      "expect": {
        "exit_code": 0,
        "stdout_contains": ["dotenv-home"],
        "stdout_not_contains": ["blocked-codex-home"]
      }
    },
    {
      "id": "codex-home-default-path-source",
      "description": "default codex home path should align to ~/.codex",
      "args": ["--help"],
      "expect": {
        "exit_code": 0
      },
      "source_checks": [
        {
          "path": "src/config.cheng",
          "contains": "return os.joinPath(home, \".codex\")"
        }
      ]
    },
    {
      "id": "path-helper-linux-command-v",
      "description": "linux startup should prepend helper PATH aliases including codex-linux-sandbox",
      "platforms": ["linux"],
      "env": {
        "CODEX_HOME": "{{CASE_TMP}}/codex-home"
      },
      "args": ["sandbox", "linux", "--", "sh", "-lc", "command -v apply_patch && command -v applypatch && command -v codex-linux-sandbox"],
      "expect": {
        "exit_code": 0,
        "stdout_contains": ["apply_patch", "applypatch", "codex-linux-sandbox"],
        "baseline_paths_exist": ["{{CASE_TMP}}/codex-home/tmp/arg0"],
        "cheng_paths_exist": ["{{CASE_TMP}}/codex-home/tmp/arg0"]
      }
    },
    {
      "id": "path-helper-macos-command-v",
      "description": "macOS startup should prepend helper PATH aliases for apply_patch/applypatch",
      "platforms": ["macos"],
      "env": {
        "CODEX_HOME": "{{CASE_TMP}}/codex-home"
      },
      "args": ["sandbox", "macos", "--", "sh", "-lc", "command -v apply_patch && command -v applypatch"],
      "expect": {
        "exit_code": 0,
        "stdout_contains": ["apply_patch", "applypatch"],
        "baseline_paths_exist": ["{{CASE_TMP}}/codex-home/tmp/arg0"],
        "cheng_paths_exist": ["{{CASE_TMP}}/codex-home/tmp/arg0"]
      }
    },
    {
      "id": "path-helper-warning-on-failure-source",
      "description": "arg0 startup should warn and continue if PATH helper setup fails",
      "args": ["--help"],
      "expect": {
        "exit_code": 0
      },
      "source_checks": [
        {
          "path": "src/main.cheng",
          "contains": "if ! arg0PrependPathEntryForAliases():"
        },
        {
          "path": "src/main.cheng",
          "contains": "if len(envHome) > 0:"
        },
        {
          "path": "src/main.cheng",
          "contains": "if ! os.dirExists(home):"
        },
        {
          "path": "src/main.cheng",
          "contains": "WARNING: proceeding, even though we could not update PATH"
        },
        {
          "path": "src/main.cheng",
          "contains": "WARNING: proceeding, even though we could not update PATH: "
        },
        {
          "path": "src/main.cheng",
          "contains": "WARNING: failed to clean up stale arg0 temp dirs: "
        },
        {
          "path": "src/main.cheng",
          "contains": "let paths = os.walkDirRec(tempRoot)"
        }
      ]
    },
    {
      "id": "hooks-legacy-notify-wire-shape-source",
      "description": "legacy notify payload keeps agent-turn-complete kebab-case wire fields",
      "args": ["--help"],
      "expect": {
        "exit_code": 0
      },
      "source_checks": [
        {
          "path": "src/hooks.cheng",
          "contains": "\"type\", jstrString(\"agent-turn-complete\")"
        },
        {
          "path": "src/hooks.cheng",
          "contains": "\"thread-id\""
        },
        {
          "path": "src/hooks.cheng",
          "contains": "\"last-assistant-message\""
        }
      ]
    },
    {
      "id": "hooks-after-tool-use-wire-shape-source",
      "description": "hooks module should keep after_tool_use wire payload and storage trigger wiring",
      "args": ["--help"],
      "expect": {
        "exit_code": 0
      },
      "source_checks": [
        {
          "path": "src/hooks.cheng",
          "contains": "\"event_type\", jstrString(\"after_tool_use\")"
        },
        {
          "path": "src/hooks.cheng",
          "contains": "\"tool_input\""
        },
        {
          "path": "src/hooks.cheng",
          "contains": "jstrPair(\"triggered_at\", jstrString(hooksCurrentUtcRfc3339()))"
        },
        {
          "path": "src/hooks.cheng",
          "contains": "+%Y-%m-%dT%H:%M:%SZ"
        },
        {
          "path": "src/storage.cheng",
          "contains": "dispatchAfterToolUseInternal(threadId, turnId, callId"
        }
      ]
    },
    {
      "id": "arg0-windows-helper-hidden-arg-source",
      "description": "windows helper script should use hidden apply_patch arg1 compatibility flag",
      "args": ["--help"],
      "expect": {
        "exit_code": 0
      },
      "source_checks": [
        {
          "path": "src/main.cheng",
          "contains": "ARG0_APPLY_PATCH_ARG1 = \"--codex-run-as-apply-patch\""
        },
        {
          "path": "src/main.cheng",
          "contains": "if commandMode == ARG0_APPLY_PATCH || commandMode == ARG0_APPLYPATCH"
        },
        {
          "path": "src/main.cheng",
          "contains": "ARG0_APPLY_PATCH_ARG1 + \" %*\\r\\n\""
        }
      ]
    }
  ]
}
